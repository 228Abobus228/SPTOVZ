<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–ü–¢ –û–í–ó ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      min-height: 100vh;
      background: #f5f7fa;
      color: #333;
      font-size: 25px; /* ‚Üë —É–≤–µ–ª–∏—á–µ–Ω–æ */
    }
    .sidebar {
      width: 300px;
      background: #004477;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 25px 20px;
    }
    .sidebar h1 {font-size: 30px; }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 35px;
    }
    .menu a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: background 0.2s;
      font-size: 23px;
    }
    .menu a:hover, .menu a.active { background: #0066aa; }
    .main { flex: 1; padding: 30px; overflow-y: auto; }
    h3 { color: #004477; margin-top: 0; font-size: 25px; }
    input, select, button {
      padding: 10px 14px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 17px;
    }
    button {
      background: #004477;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: 0.2s;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 17px;
    }
    button:hover { background: #0066aa; }
    .hidden { display: none; }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    .code-list div { padding: 6px 0; border-bottom: 1px solid #eee; }
    .export-btn { background: #228b22; }

  </style>
</head>
<body>

  <!-- ===== –õ–µ–≤–æ–µ –º–µ–Ω—é ===== -->
  <div class="sidebar">
    <h2>–°–ü–¢ –û–í–ó</h2>
    <div id="menu" class="menu hidden">
      <a href="#" class="active" onclick="showSection('home', this)">üè† –ì–ª–∞–≤–Ω–∞—è</a>
      <a href="#" onclick="showSection('class', this)">üè´ –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å</a>
      <a href="#" onclick="showSection('codes', this)">üîë –°–æ–∑–¥–∞—Ç—å –∫–æ–¥—ã</a>
    </div>
  </div>

  <!-- ===== –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å ===== -->
  <div class="main">

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="section-login" class="card">
      <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
      <input id="email" type="email" placeholder="Email" style="width:20%"><br>
      <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:20%"><br>
      <button onclick="login()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å (–≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–æ –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
    <div id="panel" class="hidden">

      <!-- –ì–ª–∞–≤–Ω–∞—è -->
      <div id="section-home" class="card">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
        <p><b>Email:</b> <span id="user-email">‚Äî</span></p>
        <p><b>–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ:</b> <span id="institution-name">‚Äî</span></p>
        <p><b>–¢–∏–ø:</b> <span id="institution-type">‚Äî</span></p>
      </div>

      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ -->
      <div id="section-class" class="card hidden">
        <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ (–≥—Ä—É–ø–ø—ã)</h3>
        <input id="class-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞"><br>
        <button onclick="createClass()">–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å</button>
        <div id="classes"></div>
      </div>

      <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–æ–≤ -->
      <div id="section-codes" class="card hidden">
        <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:
          <select id="class-select"></select>
        </label><br>
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤:
          <input id="count" type="number" value="1" min="1" max="100">
        </label><br>
        <button onclick="generateKeys()">–°–æ–∑–¥–∞—Ç—å –∫–æ–¥—ã</button>

        <h4>–°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤</h4>
        <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:8px;">
          <h4>–§–∏–ª—å—Ç—Ä—ã</h4>
          <select id="filter-class" onchange="applyFilters()"><option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option></select>
          <select id="filter-form" onchange="applyFilters()">
            <option value="">–í—Å–µ —Ñ–æ—Ä–º—ã</option>
            <option value="A">A (—à–∫–æ–ª–∞)</option>
            <option value="B">B (–∫–æ–ª–ª–µ–¥–∂)</option>
            <option value="C">C (–≤—É–∑)</option>
          </select>
          <select id="filter-status" onchange="applyFilters()">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="used">–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</option>
            <option value="unused">–ù–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</option>
          </select>
        </div>

        <div id="keys-list" class="code-list" style="margin-top:10px;"></div>
        <button onclick="loadKeys()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="export-btn" onclick="exportToExcel()">–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</button>
      </div>

    </div>
  </div>

<script>
let token = null;
let classes = [];
let allKeys = [];

// ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è =====
function showSection(section, link) {
  document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
  link.classList.add('active');
  document.querySelectorAll('#panel .card').forEach(div => div.classList.add('hidden'));
  document.getElementById('section-' + section).classList.remove('hidden');
}

// ===== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è =====
async function login() {
  const form = new URLSearchParams();
  form.append('username', document.getElementById('email').value);
  form.append('password', document.getElementById('password').value);

  const resp = await fetch('/token', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: form
  });
  const data = await resp.json();
  if (!resp.ok) return alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (data.detail || ''));

  token = data.access_token;
  document.getElementById('user-email').innerText = document.getElementById('email').value;
  document.getElementById('section-login').classList.add('hidden');
  document.getElementById('panel').classList.remove('hidden');
  document.getElementById('menu').classList.remove('hidden'); // üëà –º–µ–Ω—é —Ç–µ–ø–µ—Ä—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞

  await loadProfile();
  await loadClasses();
  await loadKeys();
}

// ===== –ü—Ä–æ—Ñ–∏–ª—å =====
async function loadProfile() {
  const resp = await fetch('/me', { headers: { 'Authorization': 'Bearer ' + token } });
  const data = await resp.json();
  if (!resp.ok) return alert('–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: ' + data.detail);
  document.getElementById('institution-name').innerText = data.institution_name;
  document.getElementById('institution-type').innerText =
    data.education_type === 'school' ? '–®–∫–æ–ª–∞ (—Ñ–æ—Ä–º–∞ –ê)' :
    data.education_type === 'college' ? '–ö–æ–ª–ª–µ–¥–∂ (—Ñ–æ—Ä–º–∞ B)' : '–í–£–ó (—Ñ–æ—Ä–º–∞ C)';
}

// ===== –ö–ª–∞—Å—Å—ã =====
async function createClass() {
  const name = document.getElementById('class-name').value.trim();
  if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞');
  const resp = await fetch('/class/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ name })
  });
  const data = await resp.json();
  if (resp.ok) {
    alert('–ö–ª–∞—Å—Å —Å–æ–∑–¥–∞–Ω: ' + data.name);
    document.getElementById('class-name').value = '';
    await loadClasses();
  } else alert('–û—à–∏–±–∫–∞: ' + data.detail);
}

async function loadClasses() {
  const resp = await fetch('/class/my', { headers: { 'Authorization': 'Bearer ' + token } });
  const data = await resp.json();
  if (!resp.ok) return alert('–û—à–∏–±–∫–∞: ' + data.detail);
  classes = data;
  document.getElementById('class-select').innerHTML =
    data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('classes').innerHTML =
    '<h4>–ú–æ–∏ –∫–ª–∞—Å—Å—ã:</h4>' + data.map(c => `<div>‚Ä¢ ${c.name}</div>`).join('');
  const filterSelect = document.getElementById('filter-class');
  if (filterSelect) {
    filterSelect.innerHTML = '<option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>' +
      data.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
  }
}

// ===== –ö–æ–¥—ã =====
async function generateKeys() {
  const classId = document.getElementById('class-select').value;
  const count = parseInt(document.getElementById('count').value);
  if (!classId || !count) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
  const resp = await fetch(`/class/keys/generate?class_id=${classId}&count=${count}`, {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const data = await resp.json();
  if (!resp.ok) return alert('–û—à–∏–±–∫–∞: ' + data.detail);
  await loadKeys();
}

async function loadKeys() {
  const resp = await fetch('/class/keys', { headers: { 'Authorization': 'Bearer ' + token } });
  const data = await resp.json();
  if (!resp.ok) return alert('–û—à–∏–±–∫–∞: ' + (data.detail || JSON.stringify(data)));
  allKeys = data;
  renderKeys();
}

// ===== –§–∏–ª—å—Ç—Ä—ã =====
function applyFilters() {
  const classFilter = document.getElementById('filter-class').value;
  const formFilter = document.getElementById('filter-form').value;
  const statusFilter = document.getElementById('filter-status').value;
  let filtered = allKeys;
  if (classFilter) filtered = filtered.filter(k => k.class_name === classFilter);
  if (formFilter) filtered = filtered.filter(k => k.form === formFilter);
  if (statusFilter) filtered = filtered.filter(k => statusFilter === 'used' ? k.used : !k.used);
  renderKeys(filtered);
}

function renderKeys(list = allKeys) {
  const div = document.getElementById('keys-list');
  if (list.length === 0) return div.innerHTML = '<p>–ö–æ–¥—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</p>';
  div.innerHTML = list.map(k => `
    <div>
      <b>${k.code}</b> (${k.class_name}, —Ñ–æ—Ä–º–∞ ${k.form})
      <span style="color:${k.used ? 'green' : 'red'}; font-weight:bold;">
        ${k.used ? '–ø—Ä–æ–π–¥–µ–Ω' : '–Ω–µ –ø—Ä–æ–π–¥–µ–Ω'}
      </span>
    </div>`).join('');
}

// ===== Excel =====
function exportToExcel() {
  if (!allKeys.length) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
  const rows = [['–ö–æ–¥', '–ö–ª–∞—Å—Å', '–§–æ—Ä–º–∞', '–°—Ç–∞—Ç—É—Å']];
  allKeys.forEach(k => rows.push([k.code, k.class_name, k.form, k.used ? '–ø—Ä–æ–π–¥–µ–Ω' : '–Ω–µ –ø—Ä–æ–π–¥–µ–Ω']));
  const csv = '\uFEFF' + rows.map(r => r.join(';')).join('\n'); // –¥–æ–±–∞–≤–ª—è–µ–º BOM
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'codes_export.csv';
  link.click();
}
</script>

</body>
</html>
