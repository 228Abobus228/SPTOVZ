<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–°–ü–¢ –û–í–ó ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --brand:#0b4b73;
  --brand-2:#0b6aa8;
  --bg:#f5f7fa;
  --card:#fff;
  --muted:#6b7b8c;
  --shadow:0 2px 6px rgba(0,0,0,.08);
  --radius:12px;
}
*{box-sizing:border-box;margin:0;padding:0;}
.hidden { display: none !important; }
body{
  font-family:"Segoe UI",system-ui,-apple-system,Arial;
  background:var(--bg);
  color:#333;
  display:grid;
  grid-template-columns:260px 1fr 340px;
  min-height:100vh;
}

/* Sidebar */
.sidebar{
  background:var(--brand);
  color:#fff;
  padding:20px 16px;
  display:flex;
  flex-direction:column;
  gap:10px;
  position:relative;
  z-index:1000;
}
.logo{
  text-align:center;
  font-weight:700;
  font-size:20px;
  margin-bottom:10px;
}
.menu a{
  display:block;
  text-decoration:none;
  color:#fff;
  padding:10px 12px;
  border-radius:8px;
  transition:background .2s;
}
.menu a:hover,
.menu a.active{background:var(--brand-2);}

/* Main content */
.main{
  padding:24px;
  overflow-y:auto;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom:18px;
}
h3{color:var(--brand);margin-bottom:10px;}
h4{margin:10px 0;color:var(--brand-2);}
input,select,button{
  font-size:15px;
  padding:8px 10px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-top:6px;
  margin-bottom:10px;
  width:100%;
}
button{
  background:var(--brand);
  color:#fff;
  cursor:pointer;
  border:none;
  transition:.25s;
}
button:hover{background:var(--brand-2);}
.export-btn{background:#228b22;}
.export-btn:hover{background:#2da82d;}
.code-list div{padding:4px 0;border-bottom:1px solid #eee;}

/* Rightbar */
.rightbar{
  background:#f0f4f8;
  border-left:1px solid #dbe4ec;
  padding:16px;
  overflow-y:auto;
}
.summary-card{
  background:#fff;
  border-radius:10px;
  box-shadow:var(--shadow);
  padding:14px;
  margin-bottom:12px;
}
.kpi{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
}
.tile{
  background:#f8fafc;
  border:1px solid #eef2f6;
  border-radius:8px;
  text-align:center;
  padding:8px;
}
.tile b{color:var(--brand);}
.muted{color:var(--muted);font-size:14px;}
.chart-wrap{height:150px;}
.chart-wrap--small{height:100px;}

/* Burger */
.burger{
  display:none;
  position:fixed;
  top:14px;
  left:14px;
  z-index:1500;
  width:44px;
  height:44px;
  background:var(--brand);
  color:#fff;
  border:none;
  border-radius:8px;
  justify-content:center;
  align-items:center;
  box-shadow:0 2px 8px rgba(0,0,0,.25);
}
.burger span,
.burger span::before,
.burger span::after{
  display:block;
  position:absolute;
  width:22px;
  height:2px;
  background:#fff;
  transition:.25s;
  content:"";
}
.burger span::before{top:-6px;}
.burger span::after{top:6px;}

/* Overlay */
#overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  z-index:900;
}
#overlay.show{display:block;}

/* Adaptive */
@media(max-width:1100px){
  body{grid-template-columns:1fr;}
  .rightbar{display:none;}
  .burger{display:flex;}
  .sidebar{
    position:fixed;
    top:0;
    bottom:0;
    left:-260px;
    width:240px;
    transition:left .25s;
  }
  .sidebar.open{left:0;}
  .main{padding:70px 16px 20px;}
}
  #section-login {
  max-width: 420px;
  margin: 40px auto; /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
}
#section-login input {
  width: 100%;
  background: #eaf3fe;
}
#section-login button {
  width: 100%;
  font-size: 15px;
}
  /* --- –†–µ–∂–∏–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ --- */
body.login-mode {
  display: flex;
  justify-content: center;
  align-items: center;
  background: var(--bg);
  min-height: 100vh;
}

body.login-mode .sidebar,
body.login-mode .rightbar {
  display: none !important;
}

body.login-mode .main {
  width: 100%;
  max-width: 420px;
  padding: 0 16px;
}

body.login-mode .card {
  width: 100%;
  box-shadow: var(--shadow);
  border-radius: var(--radius);
}

body.login-mode #section-login {
  display: block;
}

  .create-class {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
.create-class input {
  flex: 1;
  min-width: 180px;
}
.create-class button {
  flex-shrink: 0;
  padding: 10px 14px;
}

.class-list {
  margin-top: 10px;
  border-top: 1px solid #e0e6ee;
  padding-top: 10px;
}
.class-item {
  background: #f8fafc;
  border: 1px solid #e3e9f0;
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
  transition: transform .15s;
}
.class-item:hover {
  transform: translateX(2px);
}
.class-name {
  font-weight: 600;
  color: var(--brand);
}
.class-meta {
  color: var(--muted);
  font-size: 13px;
}


</style>
</head>
<body>

<!-- Burger -->
<button class="burger" id="burger"><span></span></button>
<div id="overlay" onclick="toggleMenu(false)"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="logo">–°–ü–¢ –û–í–ó</div>
  <nav class="menu hidden" id="menu">
    <a href="#" class="active" onclick="navTo('home',this)">üè† –ì–ª–∞–≤–Ω–∞—è</a>
    <a href="#" onclick="navTo('class',this)">üè´ –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å</a>
    <a href="#" onclick="navTo('codes',this)">üîë –°–æ–∑–¥–∞—Ç—å –∫–æ–¥—ã</a>
    <a href="#" onclick="navTo('summary',this);loadSummary();">üìä –ò—Ç–æ–≥–∏</a>
    <a href="#" onclick="logout()">üö™ –í—ã–π—Ç–∏</a>
  </nav>
</aside>

<!-- Main -->
<main class="main">
  <section id="section-login" class="card">
    <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
  </section>

  <div id="panel" class="hidden">
    <section id="section-home" class="card">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h3>
      <p><b>Email:</b> <span id="user-email">‚Äî</span></p>
      <p><b>–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ:</b> <span id="institution-name">‚Äî</span></p>
      <p><b>–¢–∏–ø:</b> <span id="institution-type">‚Äî</span></p>
    </section>

    <section id="section-class" class="card hidden">
  <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ (–≥—Ä—É–ø–ø—ã)</h3>
  <div class="create-class">
    <input id="class-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞">
    <button onclick="createClass()">–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å</button>
  </div>
  <h4>–°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Å–æ–≤</h4>
  <div id="classes" class="class-list"></div>
</section>


    <section id="section-codes" class="card hidden">
      <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
      <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</label>
      <select id="class-select"></select>
      <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤:</label>
      <input id="count" type="number" value="1" min="1" max="100">
      <button onclick="generateKeys()">–°–æ–∑–¥–∞—Ç—å –∫–æ–¥—ã</button>

      <h4>–°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤</h4>
      <div style="border-top:1px solid #ddd;margin-top:8px;padding-top:8px">
        <h4>–§–∏–ª—å—Ç—Ä—ã</h4>
        <select id="filter-class" onchange="applyFilters()"><option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option></select>
        <select id="filter-status" onchange="applyFilters()">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="unused">–ù–µ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</option>
          <option value="used">–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</option>
        </select>
      </div>
      <div id="keys-list" class="code-list" style="margin-top:10px"></div>
      <button class="export-btn" onclick="exportToExcel()">‚¨áÔ∏è –í—ã–≥—Ä—É–∑–∏—Ç—å –≤ Excel</button>
    </section>

    <section id="section-summary" class="card hidden">
      <h3>üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
      <p><b>–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ:</b> <span id="sum-inst-center">‚Äî</span></p>
      <div class="kpi" style="margin:12px 0;">
        <div class="tile"><span class="muted">–í—Å–µ–≥–æ</span><b id="sum-total-center">0</b></div>
        <div class="tile"><span class="muted">–ü—Ä–æ–π–¥–µ–Ω–æ</span><b id="sum-done-center">0</b></div>
        <div class="tile"><span class="muted">–û—Å—Ç–∞–ª–æ—Å—å</span><b id="sum-left-center">0</b></div>
      </div>
      <h4>IRP</h4><div class="chart-wrap"><canvas id="irpChart"></canvas></div>
      <h4 style="margin-top:10px;">KVERIPO</h4><div class="chart-wrap"><canvas id="kveripoChart"></canvas></div>
    </section>
  </div>
</main>

<!-- Rightbar -->
<aside class="rightbar hidden" id="rightbar">
  <div class="summary-card">
    <h3>–ò—Ç–æ–≥–∏</h3>
    <div class="muted">–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ</div>
    <div id="sum-inst">‚Äî</div>
  </div>
  <div class="summary-card">
    <div class="kpi">
      <div class="tile"><span class="muted">–í—Å–µ–≥–æ</span><b id="sum-total">0</b></div>
      <div class="tile"><span class="muted">–ü—Ä–æ–π–¥–µ–Ω–æ</span><b id="sum-done">0</b></div>
      <div class="tile"><span class="muted">–û—Å—Ç–∞–ª–æ—Å—å</span><b id="sum-left">0</b></div>
    </div>
  </div>
  <div class="summary-card">
    <div class="muted">IRP (–¥–æ–ª–∏, %)</div>
    <div class="chart-wrap--small"><canvas id="irpChartSide"></canvas></div>
  </div>
  <div class="summary-card">
    <div class="muted">KVERIPO (–¥–æ–ª–∏, %)</div>
    <div class="chart-wrap--small"><canvas id="kveripoChartSide"></canvas></div>
  </div>
</aside>

<script>
/* === JS –∏–∑ —Ç–≤–æ–µ–π –≤–µ—Ä—Å–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏ === */
let token=localStorage.getItem('spt_token');
if (!token) document.body.classList.add('login-mode');
let classes=[],allKeys=[],charts={};
window.addEventListener('load',()=>{if(token)initApp();});

function toggleMenu(force){
  const sb=document.getElementById('sidebar'),ov=document.getElementById('overlay');
  const open=force===undefined?!sb.classList.contains('open'):force;
  sb.classList.toggle('open',open);
  ov.classList.toggle('show',open);
}
document.getElementById('burger').addEventListener('click',()=>toggleMenu());

function navTo(section,link){
  document.querySelectorAll('.menu a').forEach(a=>a.classList.remove('active'));
  if(link)link.classList.add('active');
  document.querySelectorAll('#panel section.card').forEach(div=>div.classList.add('hidden'));
  const el=document.getElementById('section-'+section);
  if(el)el.classList.remove('hidden');
  toggleMenu(false);
}

function makeChart(id,label,labels,data){
  const el=document.getElementById(id); if(!el)return;
  if(charts[id])charts[id].destroy();
  charts[id]=new Chart(el,{type:'bar',data:{labels,datasets:[{label,data,backgroundColor:'#0b6aa8'}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}}});
}

async function login(){
  const form=new URLSearchParams();
  form.append('username',document.getElementById('email').value);
  form.append('password',document.getElementById('password').value);
  const resp=await fetch('/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form});
  const data=await resp.json();
  if(!resp.ok)return alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+(data.detail||''));token=data.access_token;localStorage.setItem('spt_token',token);initApp();
}
function logout(){localStorage.removeItem('spt_token');token=null;location.reload();}

async function initApp(){
  document.body.classList.remove('login-mode');
  document.getElementById('section-login').classList.add('hidden');
  document.getElementById('panel').classList.remove('hidden');
  document.getElementById('menu').classList.remove('hidden');
  document.getElementById('rightbar').classList.remove('hidden');
  await Promise.all([loadProfile(),loadClasses(),loadKeys(),loadSummary()]);
  navTo('home');
}

async function loadProfile(){
  const r=await fetch('/me',{headers:{'Authorization':'Bearer '+token}}),d=await r.json();if(!r.ok)return;
  document.getElementById('user-email').innerText=d.email||'';
  document.getElementById('institution-name').innerText=d.institution_name||'';
  document.getElementById('institution-type').innerText=
    d.education_type==='school'?'–®–∫–æ–ª–∞ (—Ñ–æ—Ä–º–∞ –ê)':d.education_type==='college'?'–ö–æ–ª–ª–µ–¥–∂ (—Ñ–æ—Ä–º–∞ B)':'–í–£–ó (—Ñ–æ—Ä–º–∞ C)';
}

async function createClass() {
  const name = document.getElementById('class-name').value.trim();
  if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞');
  const resp = await fetch('/class/create', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ name })
  });
  if (!resp.ok) return alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∞—Å—Å–∞');
  document.getElementById('class-name').value = '';
  await loadClasses(); // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
}

async function loadClasses() {
  const r = await fetch('/class/my', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const d = await r.json();
  if (!r.ok) return;

  classes = d;

  // –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã
  document.getElementById('class-select').innerHTML =
    d.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('filter-class').innerHTML =
    '<option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>' +
    d.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

  // –≤—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –≤ –±–ª–æ–∫
  const list = document.getElementById('classes');
  if (!d.length) {
    list.innerHTML = '<p style="color:var(--muted)">–ö–ª–∞—Å—Å—ã –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>';
    return;
  }

  list.innerHTML = d.map(c => `
    <div class="class-item">
      <div>
        <div class="class-name">${c.name}</div>
      </div>
    </div>
  `).join('');
}

async function generateKeys(){
  const id=document.getElementById('class-select').value,cnt=parseInt(document.getElementById('count').value);
  if(!id||!cnt)return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
  await fetch(`/class/keys/generate?class_id=${id}&count=${cnt}`,{method:'POST',headers:{'Authorization':'Bearer '+token}});
  loadKeys();
}
async function loadKeys(){
  const r=await fetch('/class/keys',{headers:{'Authorization':'Bearer '+token}}),d=await r.json();if(!r.ok)return;
  allKeys=d.sort((a,b)=>(a.used===b.used?a.code.localeCompare(b.code):(a.used?1:-1)));
  renderKeys();
}
let filteredKeys = [];
function applyFilters() {
  const c = document.getElementById('filter-class').value;
  const s = document.getElementById('filter-status').value;
  let list = allKeys;
  if (c) list = list.filter(k => k.class_name === c);
  if (s) list = list.filter(k => s === 'used' ? k.used : !k.used);
  filteredKeys = list;
  renderKeys(list);
}
function renderKeys(list = allKeys) {
  const d = document.getElementById('keys-list');
  filteredKeys = list;
  if (!list.length) {
    d.innerHTML = '<p style="color:var(--muted)">–ù–µ—Ç –∫–æ–¥–æ–≤</p>';
    return;
  }
  d.innerHTML = list.map(k => `
    <div class="key-item">
      <b>${k.code}</b> ‚Äî ${k.class_name}
      <span class="key-status" style="color:${k.used ? 'green' : 'red'}">
        ${k.used ? '–ø—Ä–æ–π–¥–µ–Ω' : '–Ω–µ –ø—Ä–æ–π–¥–µ–Ω'}
      </span>
    </div>
  `).join('');
}
function exportToExcel() {
  const exportList = filteredKeys.length ? filteredKeys : allKeys;
  if (!exportList.length) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏');

  const rows = [['–ö–æ–¥']];
  exportList.forEach(k => rows.push([k.code]));
  const csv = '\uFEFF' + rows.map(r => r.join(';')).join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'codes_filtered.csv';
  a.click();
  URL.revokeObjectURL(url);
}
async function loadSummary(){
  const r=await fetch('/stats/summary',{headers:{'Authorization':'Bearer '+token}}),d=await r.json();if(!r.ok)return;
  document.getElementById('sum-inst').innerText=d.institution||'‚Äî';
  document.getElementById('sum-total').innerText=d.total??0;
  document.getElementById('sum-done').innerText=d.completed??0;
  document.getElementById('sum-left').innerText=d.remaining??0;
  document.getElementById('sum-inst-center').innerText=d.institution||'‚Äî';
  document.getElementById('sum-total-center').innerText=d.total??0;
  document.getElementById('sum-done-center').innerText=d.completed??0;
  document.getElementById('sum-left-center').innerText=d.remaining??0;
  const irpL=["–Ω–∏–∑–∫–∏–π","—Å—Ä–µ–¥–Ω–∏–π","–≤—ã—Å–æ–∫–∏–π"],kvL=["–Ω–∏–∑–∫–∏–π","–≤—ã—Å–æ–∫–∏–π"];
  const irpV=irpL.map(k=>d.irp_distribution?.[k]??0),kvV=kvL.map(k=>d.kveripo_distribution?.[k]??0);
  makeChart("irpChart","IRP",irpL,irpV);
  makeChart("irpChartSide","IRP",irpL,irpV);
  makeChart("kveripoChart","KVERIPO",kvL,kvV);
  makeChart("kveripoChartSide","KVERIPO",kvL,kvV);
}
</script>
</body>
</html>
