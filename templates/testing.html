<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>СПТ ОВЗ — Тестирование</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #f0f4ff, #e6ecff);
      font-family: "Segoe UI", sans-serif;
      color: #333;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px 40px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }
    h1, h2 {
      color: #003399;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 10px 0;
      font-size: 1.1em;
    }
    input, select {
      padding: 8px;
      font-size: 1em;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 80%;
      margin-top: 4px;
    }
    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 1.1em;
      border: none;
      border-radius: 10px;
      background: #0055ff;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover { background: #003fcc; }

    .hidden { display: none; }

    /* Вопросы */
    .question-text {
      font-size: 1.4em;
      margin-bottom: 30px;
      min-height: 80px;
    }
    .answers {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      justify-items: center;
    }
    .answer-btn {
      width: 100%;
      padding: 14px 10px;
      font-size: 1.1em;
      border: none;
      border-radius: 10px;
      background: #e0e0e0;
      cursor: pointer;
      transition: 0.2s;
    }
    .answer-btn:hover {
      background: #007bff;
      color: white;
      transform: scale(1.05);
    }
    #progress {
      margin-top: 15px;
      color: #666;
    }

    /* Блок интерпретаций */
    .interpretation {
      text-align: left;
      margin-top: 15px;
      padding: 12px 16px;
      border-radius: 10px;
      background: #f8f9ff;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
      font-size: 1.05em;
      line-height: 1.4em;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

  <!-- Старт -->
  <div id="start" class="card">
    <h1>СПТ ОВЗ</h1>
    <p><b>Начало тестирования</b></p>
    <label>Код доступа: <input id="code" placeholder="Введите код" /></label>
    <label>Возраст: <input id="age" type="number" /></label>
    <label>Пол:
      <select id="gender">
        <option value="male">Мужской</option>
        <option value="female">Женский</option>
      </select>
    </label>
    <label>Нарушение:
      <select id="diagnosis">
        <option value="hearing">Слух</option>
        <option value="vision">Зрение</option>
        <option value="motor">Моторика</option>
      </select>
    </label>
    <button onclick="startTest()">Начать тест</button>
  </div>

  <!-- Тест -->
  <div id="test" class="card hidden">
    <h2 id="test-title"></h2>
    <div id="question-container">
      <div id="question-text" class="question-text"></div>
      <div id="answers" class="answers"></div>
      <div id="progress"></div>
    </div>
    <button id="finish" class="hidden" onclick="submitAnswers()" style="background:#28a745;">Завершить тест</button>
  </div>

  <!-- Результат -->
  <div id="result" class="card hidden">
    <h2>По результатам теста:</h2>
    <div id="interpretations"></div>
  </div>

  <script>
    let sessionId = null;
    let questions = [];
    let currentIndex = 0;
    const answers = [];

    async function startTest() {
      const payload = {
        code: document.getElementById('code').value.trim(),
        age: parseInt(document.getElementById('age').value),
        gender: document.getElementById('gender').value,
        diagnosis: document.getElementById('diagnosis').value
      };

      const resp = await fetch('/session/start-test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const data = await resp.json();
      if (!resp.ok) return alert(data.detail || 'Ошибка при запуске теста');

      sessionId = data.session_id;
      questions = data.questions;

      document.getElementById('start').classList.add('hidden');
      document.getElementById('test').classList.remove('hidden');
      document.getElementById('test-title').innerText = data.test_name;

      showQuestion();
    }

    function showQuestion() {
      const finishBtn = document.getElementById('finish');
      finishBtn.classList.add('hidden');

      if (currentIndex >= questions.length) {
        document.getElementById('question-container').classList.add('hidden');
        finishBtn.classList.remove('hidden');
        return;
      }

      const q = questions[currentIndex];
      document.getElementById('question-text').innerText = q.text;

      const answersDiv = document.getElementById('answers');
      answersDiv.innerHTML = '';

      for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.className = 'answer-btn';
        btn.onclick = () => selectAnswer(q.id, i);
        answersDiv.appendChild(btn);
      }

      document.getElementById('progress').innerText =
        `Вопрос ${currentIndex + 1} из ${questions.length}`;
    }

    function selectAnswer(id, value) {
      answers.push({ id, value });
      currentIndex++;
      showQuestion();
    }

    async function submitAnswers() {
      const payload = { session_id: sessionId, answers };
      const resp = await fetch('/session/submit-answers', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const result = await resp.json();
      if (!resp.ok) return alert(result.detail || 'Ошибка при отправке ответов');

      // Скрываем тест и показываем результаты
      document.getElementById('test').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');

      const res = result.result || {};
      const interp = res.interpretations || {};
      const container = document.getElementById('interpretations');
      container.innerHTML = '';

      // Выводим только текст интерпретаций
      for (const [scale, data] of Object.entries(interp)) {
        const div = document.createElement('div');
        div.className = 'interpretation';
        div.innerHTML = `${data.text}`;
        container.appendChild(div);
      }
    }
  </script>
</body>
</html>
