<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>СПТ ОВЗ — Тестирование</title>
  <style>
    body { font-family: sans-serif; margin: 40px; max-width: 800px; }
    h1 { color: #0055aa; }
    .hidden { display: none; }
    .question { margin: 15px 0; }
    .question p { margin: 5px 0; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Электронный модуль СПТ ОВЗ</h1>
  <div id="start">
    <h2>Начало теста</h2>
    <label>Код доступа: <input id="code" value="TEST123" /></label><br><br>
    <label>Возраст: <input id="age" type="number" value="12" /></label><br><br>
    <label>Пол:
      <select id="gender">
        <option value="male">Мужской</option>
        <option value="female">Женский</option>
      </select>
    </label><br><br>
    <label>Нарушение:
      <select id="diagnosis">
        <option value="hearing">Слух</option>
        <option value="vision">Зрение</option>
        <option value="motor">Моторика</option>
      </select>
    </label><br><br>
    <button onclick="startTest()">Начать тест</button>
  </div>

  <div id="test" class="hidden">
    <h2 id="test-title"></h2>
    <form id="test-form"></form>
    <button onclick="submitAnswers()">Отправить ответы</button>
  </div>

  <div id="result" class="hidden"></div>

  <script>
    let sessionId = null;
    let questions = [];

    async function startTest() {
      const payload = {
        code: document.getElementById('code').value,
        age: parseInt(document.getElementById('age').value),
        gender: document.getElementById('gender').value,
        diagnosis: document.getElementById('diagnosis').value
      };
      const resp = await fetch('/session/start-test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok) return alert(data.detail || 'Ошибка');

      sessionId = data.session_id;
      questions = data.questions;
      document.getElementById('test-title').innerText = data.test_name;
      const form = document.getElementById('test-form');
      form.innerHTML = '';
      questions.forEach(q => {
        form.innerHTML += `
          <div class='question'>
            <p>${q.id}. ${q.text}</p>
            ${[1,2,3,4,5].map(v => `<label><input type='radio' name='q${q.id}' value='${v}'>${v}</label>`).join(' ')}
          </div>`;
      });
      document.getElementById('start').classList.add('hidden');
      document.getElementById('test').classList.remove('hidden');
    }

    async function submitAnswers() {
      const form = document.getElementById('test-form');
      const data = new FormData(form);
      const answers = questions.map(q => ({ id: q.id, value: parseInt(data.get('q' + q.id)) || 0 }));
      const payload = { session_id: sessionId, answers };
      const resp = await fetch('/session/submit-answers', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const result = await resp.json();
      document.getElementById('test').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('result').innerHTML = `
        <h3>Результаты:</h3>
        <pre>${JSON.stringify(result.result, null, 2)}</pre>
      `;
    }
  </script>
</body>
</html>
